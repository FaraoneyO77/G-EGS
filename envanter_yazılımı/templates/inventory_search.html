{% extends "base.html" %}

{% block content %}
<div class="p-4">
    <h1 class="text-3xl font-bold mb-6">{{ title }}</h1>

    <div class="card p-4 mb-6 shadow-sm">
        <h2 class="text-lg font-semibold mb-3">Filtreleme Seçenekleri</h2>
        <form method="GET" action="{{ url_for('inventory_search') }}" class="row g-3">
            
            <div class="col-md-3">
                <label for="item_type" class="form-label">Ürün Tipi</label>
                <select name="item_type" id="item_type" class="form-select">
                    <option value="">-- Tümü --</option>
                    {% for type in all_item_types %}
                    <option value="{{ type }}" {% if current_filters.get('item_type') == type %}selected{% endif %}>{{ type }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label for="model_name" class="form-label">Marka/Model</label>
                <select name="model_name" id="model_name" class="form-select">
                    <option value="">-- Tümü --</option>
                    {% for model in model_names %}
                    <option value="{{ model }}" {% if current_filters.get('model_name') == model %}selected{% endif %}>{{ model }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label for="barcode" class="form-label">Barkod No</label>
                <input type="text" name="barcode" id="barcode" class="form-control" 
                       placeholder="Barkod no içerir..." 
                       value="{{ current_filters.get('barcode', '') }}">
            </div>

            {% for attr in all_filter_attributes %}
                {% if shared_attribute_values[attr] %}
                <div class="col-md-3">
                    <label class="form-label">{{ attr }}</label>
                    <select name="{{ attr }}" class="form-select">
                        <option value="">-- Tümü --</option>
                        {% for val in shared_attribute_values[attr] %}
                        <option value="{{ val }}" {% if current_filters.get(attr) == val %}selected{% endif %}>{{ val }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            {% endfor %}

            <div class="col-12 mt-4 text-end">
                <a href="{{ url_for('inventory_search') }}" class="btn btn-secondary me-2">Filtreleri Temizle</a>
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Sorgula
                </button>
            </div>
        </form>
    </div>

    <div class="card p-4 overflow-x-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-700">Arama Sonuçları ({{ filtered_inventory|length }} kayıt)</h2>
            
            {% if filtered_inventory %}
            <a href="{{ url_for('export_search_results', **current_filters) }}" class="btn btn-success btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Excel'e Aktar
            </a>
            {% endif %}
        </div>

        {% if filtered_inventory %}
        <table class="table table-hover table-striped align-middle">
            <thead class="bg-gray-200">
                <tr>
                    <th scope="col">Kullanıcı</th>
                    <th scope="col">Kategori/Tip</th>
                    <th scope="col">Marka/Model</th>
                    <th scope="col">Barkod No</th> <th scope="col">Adet</th>
                    <th scope="col">Detaylar</th>
                </tr>
            </thead>
            <tbody>
                {% for item in filtered_inventory %}
                <tr>
                    <td>
                        <span class="fw-bold">{{ item.username }}</span>
                    </td>
                    <td>
                        {{ item.category }} <br>
                        <small class="text-muted">{{ item.type }}</small>
                    </td>
                    <td>{{ item.model_name }}</td>
                    <td>
                        <span class="font-monospace bg-light border px-2 py-1 rounded">{{ item.barcode or '-' }}</span>
                    </td>
                    <td>
                        <span class="badge bg-primary rounded-pill">{{ item.quantity }}</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-info text-white"
                                data-bs-toggle="modal"
                                data-bs-target="#detailModal"
                                data-username="{{ item.username }}"
                                data-item-type="{{ item.type }}"
                                data-item-model-name="{{ item.model_name }}"
                                data-barcode="{{ item.barcode or '' }}"
                                data-quantity="{{ item.quantity }}"
                                data-notes="{{ item.notes or '' }}"
                                data-item-details='{{ item.details | tojson | safe }}'>
                            İncele
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            {% if current_filters %}
            <div class="alert alert-warning">Seçilen kriterlere uygun envanter kaydı bulunamadı.</div>
            {% else %}
            <div class="alert alert-info">Lütfen arama yapmak için yukarıdaki filtreleri kullanın.</div>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Envanter Detayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dl class="row" id="detailModalBodyContent">
                    </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
    const detailModalEl = document.getElementById('detailModal');
    detailModalEl.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        
        const username = button.getAttribute('data-username');
        const itemType = button.getAttribute('data-item-type');
        const modelName = button.getAttribute('data-item-model-name');
        const barcode = button.getAttribute('data-barcode');
        const quantity = button.getAttribute('data-quantity');
        const notes = button.getAttribute('data-notes');
        const detailsJson = button.getAttribute('data-item-details');

        const detailModalBodyContent = document.getElementById('detailModalBodyContent');
        detailModalBodyContent.innerHTML = ''; 

        // Temel Bilgiler
        const basicDetails = {
            'Kullanıcı': username,
            'Tip': itemType,
            'Model': modelName,
            'Barkod No': barcode,
            'Adet': quantity,
        };
        
        for (const [key, value] of Object.entries(basicDetails)) {
            const dt = document.createElement('dt');
            dt.className = 'col-sm-4 fw-bold';
            dt.textContent = key + ':';
            
            const dd = document.createElement('dd');
            dd.className = 'col-sm-8';
            dd.textContent = value || '-';
            
            detailModalBodyContent.appendChild(dt);
            detailModalBodyContent.appendChild(dd);
        }

        // Notlar
        if (notes) {
            const dtNotes = document.createElement('dt');
            dtNotes.className = 'col-sm-4 text-primary fw-bold';
            dtNotes.textContent = 'NOTLAR:';
            const ddNotes = document.createElement('dd');
            ddNotes.className = 'col-sm-8 text-primary';
            ddNotes.textContent = notes;
            detailModalBodyContent.appendChild(dtNotes);
            detailModalBodyContent.appendChild(ddNotes);
        }

        // Diğer Özellikler (JSON)
        try {
            const details = JSON.parse(detailsJson);
            if (Object.keys(details).length > 0) {
                detailModalBodyContent.appendChild(document.createElement('hr')); 
                const headerDt = document.createElement('dt');
                headerDt.className = 'col-sm-12 text-center text-secondary mb-2';
                headerDt.textContent = 'Teknik Özellikler';
                detailModalBodyContent.appendChild(headerDt);
                
                for (const [key, value] of Object.entries(details)) {
                    const dt = document.createElement('dt');
                    dt.className = 'col-sm-4';
                    dt.textContent = key + ':';
                    
                    const dd = document.createElement('dd');
                    dd.className = 'col-sm-8';
                    dd.textContent = value || '-';
                    
                    detailModalBodyContent.appendChild(dt);
                    detailModalBodyContent.appendChild(dd);
                }
            }
        } catch (e) {
            console.error("Detay ayrıştırma hatası:", e);
        }
    });
</script>

{% endblock %}